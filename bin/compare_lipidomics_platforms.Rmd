---
title: "Lipidomics platforms"
output: html_document
params:
  config_file: NULL
  mae_hdf5_dir_path: NULL
  rlm_sign_hits: NULL
---

## Params
```{r}
if (paste0(R.Version()$major, ".", R.Version()$minor) != "4.2.1") {
  warning("This R notebook was implemented using R version 4.2.1")
}
print(params)
config <- yaml::read_yaml(params$config)
```

## Read input data 

Input data is a MultiAssayExperiment (MAE) object. 
```{r}
library(MultiAssayExperiment)
library(HDF5Array)

mae <- loadHDF5MultiAssayExperiment(dir = params$mae_hdf5_dir_path, 
                                     prefix = config$mae_hdf5_prefix)

mae
```

Read data from MAE
```{r}
## Function to read omics data from MAE into a scaled dataframe
## 
## @param mae_object MultiAssayExperiment object
## @param name_assay Name of omics data type
## @return List of omics measurements
read_omics_from_mae <- function(mae_object, name_assay){
  se <- mae_object[[name_assay]]
  df_wide <- data.frame(t(assay(se)))
  df_wide <- df_wide[ , colSums(is.na(df_wide))==0]
  df_wide
}
```

## Read Lipidomics data set 2 (SPLINE)
```{r}
lipid_data_set2 <- read_omics_from_mae(mae,  "Lipidomics-SPLINE | positive" )
```


### Sample metadata
```{r}
sample_metadata_set2 <- as.data.frame(colData(mae[["Lipidomics-SPLINE | positive"]]))

# Remove QC samples
sample_metadata_set2 <- sample_metadata_set2[sample_metadata_set2$Sex != 'QC',]
sample_metadata_set2 <- sample_metadata_set2[sample_metadata_set2$Sex != 'SRM',]
```


## Remove QC samples
```{r}
lipid_data_set2 <- lipid_data_set2[rownames(sample_metadata_set2),]
```


## Add EATRIS IDs
```{r}
## Add EATRIS Sample IDs
sample_metadata_set2$EATRIS_IDs <- gsub("L", "CZC", sample_metadata_set2$Patient_ID)

czc_ids <- lapply(rownames(lipid_data_set2), function(x) {
  id <-sample_metadata_set2[x, "EATRIS_IDs"]
})
rownames(lipid_data_set2) <- as.character(czc_ids)
```


### Feature metadata
```{r}
feature_metadata_set2 <- as.data.frame(rowData(mae[["Lipidomics-SPLINE | positive"]]))
```


## Histogram
```{r}
library(ggplot2)
library(dplyr)
library(tidyr)

df_long <- lipid_data_set2 %>%
  pivot_longer(cols = where(is.numeric)) %>%
  drop_na()

ggplot(df_long, aes(value)) +
  geom_histogram(bins = 30, fill = 'grey', color = 'black')
```


## Lipidomics data set 1
```{r}
lipidomics_pos_data_set1 <- lipid_data_set2 <- read_omics_from_mae(mae,  "Lipidomics, positive | transformed")
lipidomics_pos_data_set1 <- data.frame(t(lipidomics_pos_data_set1))

feature_metadata_set1 <-as.data.frame(rowData(mae[["Lipidomics, positive | transformed"]]))
## Change comma to point for numericals
feature_metadata_set1$m.z <- gsub(",", "." ,feature_metadata_set1$m.z)
feature_metadata_set1$RT..min. <- gsub(",", ".", feature_metadata_set1$RT..min.)
```


## Find overlap based on retention time and m/z columns
```{r}
source('Match_Features_directional.R')

## Add correct input columns (m/z and RT)
feature_metadata_set1$mz <- as.numeric(feature_metadata_set1$m.z)
feature_metadata_set1$rt <- as.numeric(feature_metadata_set1$RT..min.)

feature_metadata_set2$rt <- as.numeric(feature_metadata_set2$RT..min.)
feature_metadata_set2$mz <- as.numeric(feature_metadata_set2$mz)
feature_metadata_set2$IMTM_Feature_ID <- rownames(feature_metadata_set2)
```


```{r}
matches <- match_features_bidirectional(
  feature_metadata_set1,
  feature_metadata_set2,
  mz1_col    = "mz",
  rt1_col    = "rt",
  mz2_col    = "mz",
  rt2_col    = "rt",
  mz_tol_ppm = 10,
  rt_tol_min = 2
)
```


## Intersection of data samples
```{r}
## Find sample intersection
intersection_samples <- match(rownames(lipid_data_set2), rownames(lipidomics_pos_data_set1))

## Set to same samples and order
lipidomics_pos_data_set1 <- lipidomics_pos_data_set1[intersection_samples, ]
```


## Correlate intersection of lipids
```{r}
correlations <- sapply(seq(1:nrow(matches)), function(row) {
  lipid_set1 <- feature_metadata_set1[matches$df1_row[[row]], 'IMTM_Feature_ID']
  lipid_set2 <- feature_metadata_set2[matches$df2_row[[row]], 'IMTM_Feature_ID']
  cor(lipidomics_pos_data_set1[[lipid_set1]], 
      lipid_data_set2[[lipid_set2]], use = "complete.obs") 
  })
df_correlations <- data.frame(correlations, rownames(matches))
colnames(df_correlations) <- c('Correlation', 'Matches_ID')
df_correlations$Set1_ID <- feature_metadata_set1[matches$df1_row, "IMTM_Feature_ID"]
df_correlations$Set1_LipidMap <- feature_metadata_set1[matches$df1_row, "Name"]
df_correlations$Set2_ID <- feature_metadata_set2[matches$df2_row, "IMTM_Feature_ID"]
df_correlations$Set2_LipidMap <- feature_metadata_set2[matches$df2_row, "Name"]
```


```{r}
ggp <- ggplot(data.frame(cor = correlations), aes(x=cor)) +
  geom_histogram(binwidth = 0.025, fill = 'skyblue1', color = "black") +
  ggtitle(paste0('Correlations between lipidomics data sets\nn = ',
                 nrow(df_correlations))) +
  xlab('Correlation') +
  ylab('Overlapping lipid count')

ggsave("Lipidomics_platforms_cor.pdf", ggp, width = 6, height = 4)

ggp
```


```{r}
cor_plot <- function(row) {
  
  feature_1 <- row[, "Set1_ID"]
  feature_2 <- row[, "Set2_ID"]
  name <- row[, "Set1_LipidMap"]
  
  x <- lipidomics_pos_data_set1[, feature_1]
  y <- lipid_data_set2[, feature_2]
  
  plot(x, y, 
       main = name,
       xlab = 'Set 1', ylab= 'Set 2')
  model <- lm(y ~ x)
  abline(model, col = "red", lwd =2)
  r <- cor(x, y, use = "complete.obs")
  legend("topleft", legend = paste("r = ", round(r,2)), bty = "n")
}
```


```{r}
df_correlations_sorted <- df_correlations[order(df_correlations$Correlation, decreasing = T),]
head(df_correlations_sorted, 3)
```


# Top 5 correlated lipids
```{r}
pdf("Lipidomics_platforms_score_plots_top.pdf")
           
cor_plot(df_correlations_sorted[1,])
cor_plot(df_correlations_sorted[2,])
cor_plot(df_correlations_sorted[3,])
cor_plot(df_correlations_sorted[4,])
cor_plot(df_correlations_sorted[5,])

dev.off()
```


# Linear models results

## Read significant results
```{r}
mae_rlm_all_merged <- read.csv(params$rlm_sign_hits, row.names = 1)
```

## Check for overlapping lipids in RLM results
```{r}
mae_rlm_all_merged_intersection_lipid_set1 <- mae_rlm_all_merged[mae_rlm_all_merged$feature %in% df_correlations$Set1_ID,]
mae_rlm_all_merged_intersection_lipid_set1


mae_rlm_all_merged_intersection_lipid_set2 <- mae_rlm_all_merged[mae_rlm_all_merged$feature %in% df_correlations$Set2_ID,]
mae_rlm_all_merged_intersection_lipid_set2
```

## Check overlap of associations, per feature per phenotypic variable
```{r}
rlm_hits_set1_summarized <- mae_rlm_all_merged_intersection_lipid_set1[, c('outcome', 'assay', 'feature', 'feature2')] %>%
  tidyr::pivot_wider(names_from = assay, values_from = outcome)
colnames(rlm_hits_set1_summarized) <- c('feature', 'feature2', 'RLM_associations_df1')

rlm_hits_set1_summarized$Matches_ID <- df_correlations$Matches_ID[match(rlm_hits_set1_summarized$feature, df_correlations$Set1_ID)]

rlm_hits_set2_summarized <- mae_rlm_all_merged_intersection_lipid_set2[, c('outcome', 'assay', 'feature', "feature2")] %>%
  tidyr::pivot_wider(names_from = assay, values_from = outcome)
colnames(rlm_hits_set2_summarized) <- c('feature', 'feature2', 'RLM_associations_df2')
rlm_hits_set2_summarized$Matches_ID <- df_correlations$Matches_ID[match(rlm_hits_set2_summarized$feature, df_correlations$Set2_ID)]


# Function to calculate overlap statistics
calculate_overlaps <- function(df1, df2, feature_col = "feature", char_col = "RLM_associations") {
  # Merge dataframes on feature column
  merged <- inner_join(df1, df2, by = feature_col, suffix = c("_df1", "_df2"))
  
  # Calculate overlaps for each feature
  merged %>%
    rowwise() %>%
    mutate(
      overlap = list(intersect(get(paste0(char_col, "_df1")), 
                               get(paste0(char_col, "_df2")))),
      n_overlap = length(overlap),
      n_df1 = length(get(paste0(char_col, "_df1"))),
      n_df2 = length(get(paste0(char_col, "_df2"))),
      jaccard = n_overlap / length(union(get(paste0(char_col, "_df1")), 
                                          get(paste0(char_col, "_df2")))),
      overlap_pct_df1 = n_overlap / n_df1 * 100,
      overlap_pct_df2 = n_overlap / n_df2 * 100
    ) %>%
    ungroup()
}

overlap_RLM_results <- calculate_overlaps(rlm_hits_set1_summarized, rlm_hits_set2_summarized, feature_col = "Matches_ID")
```


Plot overlapping RLM associations
```{r, fig.width=10}
table <- sort(table(unlist(overlap_RLM_results$overlap)), decreasing = T)
barplot(table, ylab = 'Overlapping lipids')
```
