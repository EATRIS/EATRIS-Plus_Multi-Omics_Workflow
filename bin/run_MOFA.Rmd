---
title: 'Multi-omics Factor Analysis (MOFA)'
author:
- Anna Niehues^[Radboud university medical center, Anna.Niehues@radboudumc.nl]
output:
  html_document:
    toc: true
    df_print: paged
params:
  config_file: NULL
  references: NULL
  mae_hdf5_dir_path: NULL
---

This notebook performs Multi-omics Factor Analysis (MOFA) [@Argelaguet2018,@Argelaguet2020] on preprocessed data. 

MOFA is an unsupervised method that uncovers main sources of variation in multi-omics data. It allows to identify variation shared across omics data types or specific to individual omics data types. 
Subsequent to MOFA, correlation between MOFA factors and phenotypic information is determined to identify possible biological factors contributing to the observed variation.


```{r show_parameters}
if (paste0(R.Version()$major, ".", R.Version()$minor) != "4.2.1") {
  warning("This R notebook was implemented using R version 4.2.1")
}
print(params)
config <- yaml::read_yaml(params$config)
```


## R Libraries
```{r, libraries}
library(MOFA2)
library(data.table)
library(tidyr)
library(dplyr)
library(gridExtra)
library(ggplot2)
library(ggcorrplot)
library(psych)
library(ggpubr)
library(rstatix)
library(ggokabeito)
```
## Read input data

Input data is a MultiAssayExperiment (MAE) object. All or specified assays in the MAE will be used for analysis Multi-omics Factor Analysis (MOFA).

```{r read_input_data, message=FALSE}
library(MultiAssayExperiment)
library(HDF5Array)

mae <- loadHDF5MultiAssayExperiment(dir = params$mae_hdf5_dir_path, 
                                    prefix = config$mae_hdf5_prefix)
```

Select male/female individuals based on input parameters

```{r select_input_samples}
sample_selection <- c()
if (config$sample_selection$include_MALE) {
  sample_selection <- c(sample_selection, "MALE")}
if (config$sample_selection$include_FEMALE) {
  sample_selection <- c(sample_selection, "FEMALE")}

mae <- mae[, colData(mae)$Sex %in% sample_selection]

mae
```


### Merge metabolomics, merge lipidomics

Assays are merged so that they can be used as single modality in MOFA

```{r merge_selected_omics}
# # merge se
# mtblms_se <- list(mae[["Amino acids"]], mae[["Acylcarnitines"]],
#                   mae[["Very long chain fatty acids"]])
# mtblms_se <- lapply(mtblms_se, function(se) {
#   rowdata_df <- data.frame(rowData(se))
#   if (!"HMDB.ID.s." %in% names(rowdata_df)) {
#     rowdata_df$HMDB.ID.s. <- NA
#   }
#   se <- SummarizedExperiment(assays = assays(se), rowData = rowdata_df)
# })
# se_metabolomics <- do.call(rbind, mtblms_se)
# mae <- c(mae, `Metabolomics` = se_metabolomics)
# 
# # merge se
# lpdms_se <- list(mae[["Lipidomics, positive"]], mae[["Lipidomics, negative"]])
# lpdms_se <- lapply(lpdms_se, function(se) {
#   rowdata_df <- data.frame(rowData(se))
#   if (!"RT.sec." %in% names(rowdata_df)) {
#     rowdata_df$RT.sec. <- NA
#   }
#   se <- SummarizedExperiment(assays = assays(se), rowData = rowdata_df)
# })
# se_lipidomics <- do.call(rbind, lpdms_se)
# mae <- c(mae, `Lipidomics` = se_lipidomics)
```

### Experiment selection

Omics types to be included in MOFA, selected from the config.yml file.

```{r get_assay_names}
assay_names <- config$experiment_names$MOFA
names(assay_names) <- assay_names
```


## Get omics names list
```{r}
assay_names <- config$experiment_names$MOFA

# Mapping of original to readable names
assay_name_map <- config$readable_names

# Translate assay names using the map
shorter_assay_names <- sapply(assay_names, function(x) {
  if (!is.null(assay_name_map[[x]])) {
    assay_name_map[[x]]
  } else {
    x  # fallback to original name
  }
})


# Create a data frame for reference
assay_names_df <- data.frame(
  original = assay_names,
  readable = shorter_assay_names,
  stringsAsFactors = FALSE
)

print(assay_names_df)
```


## Multi-omics factor analysis (MOFA)

For running MOFA, it is recommended to first remove known batch effects. 
Make sure to use input data that were adjusted for batch effect if necessary.

Prepare MOFA input data: create a long data frame with sample, feature, view, 
[group], and value. 

```{r functions_for_mofa_input, message=FALSE}


#' Convert omics data to long format
wide_to_long_keep_samples <- function(df) {
  df$sample <- rownames(df)
  gather(df, key = "feature", value = "value", -sample, factor_key = TRUE)
}

#' Prepare MultiAssayExperiment for MOFA
#' If both hematology and phenotype data are selected, they are merged to one data modality.
#'
#' @param mae A MultiAssayExperiment.
#' @param hematology A boolean indicating whether to include clinical hematology as data modality in MOFA. 
#' @param phenotype A boolean indicating whether to include additional phenotype information as data modality in MOFA.
#' @param assay_selection An optional character vector with assay names to be included in analysis.
#' @returns A long data frame.
mae_to_MOFAinput <- function(mae, 
                             hematology = TRUE, 
                             phenotype = TRUE, 
                             assay_selection = NULL) {
  if (is.null(assay_selection)) {
    # use all assays from MAE MultiAssayExperiment 
    assay_names <- names(assays(mae))
  } else {
    assay_names <- assay_selection
  }
  names(assay_names) <- assay_names
  
  # get omics data from SummarizedExperiments
  assay_list <- lapply(assay_names, function(assay_name) {

    se <- mae[[assay_name]]
    df_wide <- data.frame(t(assay(se)))
 
    

    # standardize data
    df_wide <- as.data.frame(t(scale(t(df_wide), center = TRUE, scale = TRUE)))
    
    # convert wide to long data frame
    df_long <- wide_to_long_keep_samples(df_wide)
    # shorten assay name of targeted metabolomics assays
    assay_shortname <- ifelse(
      grepl("_metabolite_profiling", assay_name),
      strsplit(assay_name, "_")[[1]][2],
      assay_name)
    df_long$view <- assay_shortname
    df_long
  }) 
  merged_assay_data <- do.call(rbind, assay_list)
  
  # phenotype and hematology data
  phenotype_vars <- c("Age", "BMI", "Height", "Weight")
  hematology_vars <- c("Leukocytes", "Erythrocytes", "Hemoglobin", "Hematocrit",
                       "Platelets", "MCV", "MCH", "MCHC", "Lymphocytes", "MXD",
                       "Neutrophils")
  additional_vars <- c()
  if (hematology) {
    additional_vars <- c(additional_vars, hematology_vars)
  }
  if (phenotype) {
    additional_vars <- c(additional_vars, phenotype_vars)
  }
  if (length(additional_vars) > 0) {
    phenotype_data <- colData(mae)[, additional_vars]
    phenotype_data <- as.data.frame(phenotype_data)
    # log-transform hematology variables
    if (hematology) {
      phenotype_data[, hematology_vars] <- log(
        phenotype_data[, hematology_vars] + 1)
      # standardize
      phenotype_data <- as.data.frame(scale(
        phenotype_data, center = TRUE, scale = TRUE))
    }
    phenotype_data_long <- wide_to_long_keep_samples(phenotype_data)
    phenotype_data_long$view <- "Hematology"
    
    merged_assay_data <- rbind(merged_assay_data, phenotype_data_long)
  }
  merged_assay_data
}

```


```{r prepare_mofa_input}
mofa_input <- mae_to_MOFAinput(
  mae, 
  config$additional_data_types$include_hematology, 
  config$additional_data_types$include_phenotype,
  assay_selection = assay_names)

if (config$additional_data_types$include_hematology) {
  mofa_input$view <- factor(mofa_input$view, levels = c(
       "Hematology", assay_names))
} else {
  mofa_input$view <- factor(mofa_input$view, levels = assay_names)
}

mofa_input$view <- assay_names_df$readable[match(mofa_input$view, assay_names_df$original)]
```

Create the MOFA object

```{r create_mofa_object}
MOFAobject <- create_mofa(mofa_input)
print(MOFAobject)
```

Plot views available in MOFA object (N = number of samples, D = number of 
features per view)

```{r show_mofa_modalities}
require(ggplot2)
ggp <- plot_data_overview(MOFAobject)

ggsave(file.path("MOFA_modality_overview.png"), 
       ggp, width = 15, height = 10.46, units = "cm", dpi = 300)

ggp
```


Get parameters of MOFA object

```{r}
data_opts <- get_default_data_options(MOFAobject)
data_opts$scale_views <- TRUE
data_opts
```

Set number of factors. This parameter can have a large impact on the results.

```{r}
model_opts <- get_default_model_options(MOFAobject)
model_opts$num_factors <- config$num_MOFA_factors
model_opts
```


```{r}
train_opts <- get_default_training_options(MOFAobject)
train_opts
```

Prepare MOFA object for training using the parameters specified above

```{r}
MOFAobject <- prepare_mofa(
  object = MOFAobject,
  data_options = data_opts,
  model_options = model_opts,
  training_options = train_opts
)
```


**NOTE:** `mofa2` requires a Python installation with `mofapy2`

`mofapy2` can be installed from PyPi using conda:

```
conda create -n mofapy2 python pip
conda activate mofapy2
pip install mofapy2
```

In case of computing environments without internet access, the conda environment 
can be created on a computer with internet and pip dependencies for `mofapy2` 
can be downloaded:

```
pip list --format=freeze > requirements.txt
pip download -r requirements.txt
```

After uploading the dependencies to the environment without internet access, 
`mofapy2` can be installed with pip defining the path to the package wheel:

```
pip install --no-index --find-links Z:/software/pip Z:/software/pip/mofapy2-0.6.7-py3-none-any.whl
```

The conda environment with Python can now be used by `reticulate` in R.

```{r define_python_version}
reticulate::use_python("/usr/bin/python3", required = T)
```

Train the MOFA model

```{r run_mofa, message=FALSE}
outfile = file.path('model.hdf5')
MOFAobject.trained <- run_mofa(MOFAobject, outfile)
```


## Visualizations of MOFA results 

### Variance decomposition

Amount of variance explained per modality (= view, = assay)

```{r}
head(MOFAobject.trained@cache$variance_explained$r2_total)
```

Amount of variance explained by each factor per modality

```{r}
head(MOFAobject.trained@cache$variance_explained$r2_per_factor)
```

Plot amount of variance explained by each factor per modality

```{r}
expl_var <- c(
  get_variance_explained(MOFAobject.trained)$r2_per_factor$single_group)

ggp <- plot_variance_explained(MOFAobject.trained) +
  geom_text(
    label = round(expl_var, 2),
    color = ifelse(expl_var < 0.6*max(expl_var), "black", "white")) +
  theme(
    axis.text.x = element_text(angle = 30, vjust = 1, hjust = 1)
  )
      

ggsave(file.path("MOFA_explained_variance.pdf"), 
       ggp, width = 14, height = 10.46, units = "cm", dpi = 300)

ggp
```

###  Factor correlations

Plot correlations between factors. When factors are correlated (containing 
redundant information) it is recommended to reduce the number of factors

```{r}
plot_factor_cor(MOFAobject.trained)
```

### Factor weights

Plot feature weights per factor and assay

```{r}
num_factors <- nrow(
  MOFAobject.trained@cache$variance_explained$r2_per_factor[[1]])
view_names <- names(MOFAobject.trained@data)

lapply(1:5, function(f) {
  lapply(view_names, function(a) {
    plot_weights(
      MOFAobject.trained,
      view = a,
      factor = f,
      nfeatures = 10
      )+ ggtitle(paste0(a))
  }) 
})
```

Top weights per factor and assay

```{r}
lapply(1:5, function(f) { 
  lapply(view_names, function(a) {
    plot_top_weights(
      MOFAobject.trained,
      view = a,
      factor = f,
      nfeatures = 10
    ) + ggtitle(paste0(a))
  })
})
```


### Correlation of factor scores with continuous phenotype variables

Add metadata for plotting results

```{r}
mofa_metadata <- as.data.frame(colData(mae)) %>%
  select(c("subject.id", "Sex", "Age.group", "BMI.group", "Smoking.Status", 
           "ABO.Blood.Group", "Rh.Blood.Group", "Genomic_Abberation"))
mofa_metadata$sample <- mofa_metadata$subject.id
samples_metadata(MOFAobject.trained) <- mofa_metadata
```


```{r}
# get data
mofa_factors <- get_factors(MOFAobject.trained)$single_group
continuous_phenotype_data <- as.data.frame(
  colData(mae))[, c("Age", "Height", "Weight", "BMI",
                    "Leukocytes", "Erythrocytes", "Hemoglobin", "Hematocrit",
                    "Platelets", "MCV", "MCH", "MCHC", "Lymphocytes", "MXD", "Neutrophils" 
                    )]

# calculate Spearman correlation
mofa_factor_phenotype_cor <- cor(
  continuous_phenotype_data,
  mofa_factors, 
  use = 'pairwise.complete.obs', 
  method = "spearman")

# calculate FDR-adjusted p-values
mofa_factor_phenotype_sigtest = psych::corr.test(
  continuous_phenotype_data,
  mofa_factors, 
  use = 'pairwise', 
  method = "spearman",
  adjust = "BH"
)

# correlation plot
ggp <- ggcorrplot(
  mofa_factor_phenotype_cor, 
  hc.order = FALSE,
  p.mat = mofa_factor_phenotype_sigtest$p.adj) 

minmax <- max(abs(c(
  min(mofa_factor_phenotype_cor), max(mofa_factor_phenotype_cor)
)))
minmax <- ifelse(
  round(minmax, 1) < minmax, round(minmax+0.1, 1), round(minmax, 1))
ggp <- ggp + scale_fill_gradient2(
  limit = c(-minmax, minmax), 
  low = "blue", high = "red", mid = "white", midpoint = 0
)

ggsave(file.path("MOFA_factors_vs_continuous.png"), 
       ggp, width = 28.04, height = 10.46, units = "cm", dpi = 300)
ggp
```


### MOFA Factors vs Predicted Age

```{r}
continuous_phenotype_data <- as.data.frame(
  colData(mae))[, c("Age", "Age_pred_BLUP", "Age_acc_BLUP", "Age_pred_Levine", "Age_acc_Levine"
                    )]

# Convert to numericals
continuous_phenotype_data$Age_acc_Levine <- as.numeric(continuous_phenotype_data$Age_acc_Levine)
continuous_phenotype_data$Age_acc_BLUP <- as.numeric(continuous_phenotype_data$Age_acc_BLUP)
continuous_phenotype_data$Age_pred_Levine <- as.numeric(continuous_phenotype_data$Age_pred_Levine)
continuous_phenotype_data$Age_pred_BLUP <- as.numeric(continuous_phenotype_data$Age_pred_BLUP)

# calculate Spearman correlation
mofa_factor_phenotype_cor <- cor(
  continuous_phenotype_data,
  mofa_factors,
  use = 'pairwise.complete.obs',
  method = "spearman")

# calculate FDR-adjusted p-values
mofa_factor_phenotype_sigtest = psych::corr.test(
  continuous_phenotype_data,
  mofa_factors,
  use = 'pairwise',
  method = "spearman",
  adjust = "BH"
)

# correlation plot
ggp <- ggcorrplot(
  mofa_factor_phenotype_cor,
  hc.order = FALSE,
  p.mat = mofa_factor_phenotype_sigtest$p.adj)

minmax <- max(abs(c(
  min(mofa_factor_phenotype_cor), max(mofa_factor_phenotype_cor)
)))
minmax <- ifelse(
  round(minmax, 1) < minmax, round(minmax+0.1, 1), round(minmax, 1))
ggp <- ggp + scale_fill_gradient2(
  limit = c(-minmax, minmax),
  low = "blue", high = "red", mid = "white", midpoint = 0
)

ggsave(file.path("MOFA_factors_vs_Age.png"),
       ggp, width = 28.04, height = 10.46, units = "cm", dpi = 300)
ggp
```


### Distributions of sample factor scores per phenotype category

Pick signficant differences for manuscript figure
```{r}


ggp_sex <- plot_factor(MOFAobject.trained, color_by = "Sex", factors = c(1, 6), add_boxplot=T) + 
  stat_compare_means(method = "wilcox.test", label = "p.signif")
ggp_age <- plot_factor(MOFAobject.trained, color_by = "Age.group", factors = c(9, 11), add_boxplot=T) + 
  stat_compare_means(method = "kruskal.test", label = "p.signif")
ggp_bmi <- plot_factor(MOFAobject.trained, color_by = "BMI.group", factors=c(1, 2), add_boxplot=T) + 
  stat_compare_means(method = "kruskal.test", label = "p.signif")

grob1 <- ggplotGrob(ggp_sex)
grob2 <- ggplotGrob(ggp_age)
grob3 <- ggplotGrob(ggp_bmi)

pdf("MOFA_factors_Significants.pdf", width = 14, height = 5)
grid.arrange(grob1, grob2, grob3, ncol = 3)
dev.off()
```


Age group
```{r, fig.width=16, fig.height=5}
plot_factor(MOFAobject.trained, color_by = "Age.group", factors = c(1:12), add_boxplot=T)
```

Sex
```{r, fig.width=15, fig.height=5}
plot_factor(MOFAobject.trained, color_by = "Sex", factors = c(1:12), add_boxplot=T)
```

Smoking status
```{r, fig.width=15, fig.height=5}
plot_factor(MOFAobject.trained, color_by = "Smoking.Status", factors = c(1:12), add_boxplot=T)
```

BMI
```{r, fig.width=15, fig.height=5}
plot_factor(MOFAobject.trained, color_by = "BMI.group", factors = c(1:12), add_boxplot=T)
```

#### Blood group

```{r, fig.width=15, fig.height=5}
plot_factor(MOFAobject.trained, color_by = "ABO.Blood.Group", factors = c(1:12), add_boxplot=T)
```

```{r, fig.width=15, fig.height=5}
plot_factor(MOFAobject.trained, color_by = "Rh.Blood.Group", factors = c(1:12))
```


## Save MOFA results

MOFA factor weights and omics feature annotations are saved for downstream 
analyses such as pathway enrichment analysis (PEA).

```{r}
MOFA_weights <- get_weights(MOFAobject.trained)
names(MOFA_weights) <- lapply(names(MOFA_weights), function(x) {
    new_name <- assay_names_df[assay_names_df$readable == x, 1]
    new_name
}) 


lapply(assay_names, function(a) {

  df <- cbind(MOFA_weights[[a]], data.frame(rowData(mae[[a]])))
  
  f <- gsub("[| ,]", "_", a)
  write.csv(df, file = file.path(paste0("factorweights_", f, ".csv")))
})
```


## Session information

```{r}
sessionInfo()
```

## References
