---
title: 'Prepare chunks to anallyze large omics data sets with linear models'
author:
  - Casper de Visser^[Radboud university medical center, Casper.deVisser@radboudumc.nl]
output:
  html_document:
    toc: true
    df_print: paged
params:
  mae_hdf5_path: path/to/h5MAE
  outdir: outidr
---

```{r}
if (paste0(R.Version()$major, ".", R.Version()$minor) != "4.2.1") {
  warning("This R notebook was implemented using R version 4.2.1")
}
```

## Read data and metadata: MultiAssayExperiment

The `MultiAssayExperiment` contains preprocessed data and has been created with the R notebook https://gitlab.cmbi.umcn.nl/eatris-plus/mtblm_data_preparation/-/blob/main/R_data_preprocessing/preprocessing_targeted_metabolomics_data/Rmd. Specific assays/experiments used in this analysis are defined below.

```{r read_multiassayexperiment}
library(MultiAssayExperiment)

mae <- loadHDF5MultiAssayExperiment(
  dir = params$mae_hdf5_path, 
  prefix = 'mae')
mae
```



## Read SE function
```{r}
get_df_input_lm <- function(se) {
  # create data frame with omics feature values
  df <- as.data.frame(t(assays(se)[[1]]))
  # remove non-variable features
  df <- df[, apply(df, 2, function(column) {
    var(column, na.rm = T) != 0 })]
  # remove extremely sparse features
  xpercent <- nrow(df)*0.5
  df <- df[, apply(df, 2, function(column) {
    sum(column == 0, na.rm = T) < xpercent })]
   
  # --> TODO: add mae as parameter and use experiment name to select se
  # add assay-specific technical variables to data frame
  return(df)
}

split_in_chunks <- function(df, n_chunks) {
  chunk_size <- ceiling(ncol(df)/n_chunks)
  split_df <- lapply(seq(1, ncol(df), by = chunk_size), function(i) df[,i:min(i+ chunk_size -1, ncol(df))])
  return(split_df)
}
```


## Outcomes
```{r}
# outcome variables
outcomes <- c(
  "Sex", "Age", "Age.group", 
  "Height", "Weight", "BMI", "BMI.group", 
  "Smoking.Status", "ABO.Blood.Group", "Rh.Blood.Group", 
  "Leukocytes", "Erythrocytes", "Hemoglobin", "Hematocrit", "Platelets", "MCV", 
  "MCH", "MCHC", "Lymphocytes", "MXD", "Neutrophils",
  "Age_pred_BLUP", "Age_acc_BLUP",   "Age_pred_Levine", "Age_acc_Levine")
```


## Split data into chunks, add phenotypic columns and save to .csv files
```{r}
assay_name <- "EM-seq | cell-type adjusted | 100,000 most variable CpG sites"
se <- experiments(mae)[assay_name]
df <- get_df_input_lm(se)

chunks_df <- split_in_chunks(df, 100)

lapply(71:100, function(x) {
  # add pheno variables to data frame
  chunk <- chunks_df[[x]]
  chunk <- cbind(chunk, colData(mae)[rownames(chunk), outcomes])
  write.csv(chunk, paste0('Chunk_', x, '.csv'))
})
```


## Session information
```{r}
sessionInfo()
```


